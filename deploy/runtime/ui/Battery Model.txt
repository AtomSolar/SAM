Battery Model
1052
68
2
GroupBox

1
8
Name
5
23
Battery Chemistry Group
X
3
6
Y
3
3
Width
3
1042
Height
3
60
Tool Tip
5
0
Caption
5
9
Chemistry
Bold
2
1
Choice

1
9
Name
5
9
batt_type
X
3
153
Y
3
24
Width
3
438
Height
3
24
Tool Tip
5
0
Items
6
11
Lead Acid Flooded
Lead Acid VRLA Gel
Lead Acid VRLA AGM
Lead Acid Custom
Lithium-ion Lithium Manganese Oxide (LMO/Graphite)
Lithium-ion Lithium Iron Phosphate (LFP/Graphite)
Lithium-ion Lithium Cobalt Oxide (LCO/Graphite)
Lithium-ion LMO/Lithium Titanate (LMO/LTO)
Lithium-ion Nickel Manganese Cobalt Oxide (NMC/Graphite)
Lithium-ion Nickel Cobalt Aluminum Oxide (NCA/Graphite)
Lithium-ion Custom
Selection
3
4294967295
TabOrder
3
1

12
LeadAcid_q10
3
1
Discharge rate 10-hour
%
BatteryCell
0
2
1
1
1
1
93
Default
LeadAcid_q10_computed
3
1
Discharge rate 10-hour calculated
Ah
BatteryCell
0
8
1
1
1
1
0
Numeric
LeadAcid_q20
3
1
Discharge rate 10-hour
%
BatteryCell
0
2
1
1
1
1
100
Default
LeadAcid_q20_computed
3
1
Discharge rate 10-hour calculated
Ah
BatteryCell
0
8
1
1
1
1
0
Numeric
LeadAcid_qn
3
1
Capacity at n-hour discharge rate
%
BatteryCell
0
1
1
1
1
1
60
Default
LeadAcid_qn_computed
3
1
Capacity at n-hour discharge rate calculated
Ah
BatteryCell
0
8
1
1
1
1
0
Numeric
LeadAcid_tn
3
1
Hours of storage
hours
BatteryCell
0
1
1
1
1
1
1
Default
batt_Qexp
3
1
Battery capacity exp
Ah
BatteryCell
0
9
1
1
1
1
1
Numeric
batt_Qnom
3
1
Battery capacity nominal
Ah
BatteryCell
0
9
1
1
1
1
56
Numeric
batt_chem
3
1
Battery chemistry options
 
BatteryCell
0
9
1
1
1
1
1
Default
batt_meter_position
3
1
Battery meter position
 
BatteryCell
0
0
1
1
1
1
0
Default
batt_type
3
1
Battery type
 
BatteryCell
449
Lead Acid: Flooded|Lead Acid: VRLA Gel|Lead Acid: VRLA AGM|Lead Acid: Custom|Lithium Ion: Lithium Manganese Oxide (LMO/Graphite)|Lithium Ion: Lithium Iron Phosphate (LFP/Graphite)|Lithium Ion: Lithium Cobalt Oxide (LCO/Graphite)|Lithium Ion: LMO/Lithium Titanate (LMO/LTO)|Lithium Ion: Nickel Manganese Cobalt Oxide (NMC/Graphite)|Lithium Ion: Nickel Cobalt Aluminum Oxide (NCA/Graphite)|Lithium Ion: Custom|Flow Battery: Vanadium|Flow Battery: Iron
2
1
1
1
1
0
Choice

270
equations{ 'batt_chem' } = define(){
	// lead acid
	if (${batt_type} <= 3)
		return 0;
	// lithium ion
	else if (${batt_type} <= 10)
		return 1;
	// vanadium redox flow
	else if (${batt_type} == 11)
		return 2;
	// iron flow
	else if (${batt_type} == 12)
		return 3;
};

14249
on_load{'Battery Model'} = define()
{
	set_chemistry();
	set_meter_position();
	battsize_warning_check();
	on_change{'batt_type'};
};

on_change{'batt_type'} = define()
{
	type = value('batt_type');
	
	if (type != 3 && type != 10)
		update_default = yesno('Replace inputs with default values for this battery type?');
	else
		update_default = false;
	
	islead = (value('batt_chem') == 0);
	islithium = (value('batt_chem') == 1);
	isvanadium = (value('batt_chem') == 2);
	isiron = (value('batt_chem') == 3);
	set_chemistry();
	
	// call to other script (Battery Bank Sizing)
	set_bank_sizing();
	
	// call to other script (Battery Voltage)
	set_voltage_choice(update_default);
	
	// call to other script (Battery Current and Capacity)
	set_current_and_capacity();
	
	// lead acid
	if (islead)
		set_lead_acid(update_default);
	// Lithium Ion
	else if (islithium)
		set_lithium_ion(update_default);
	// Vanadium Redox FLow
	else if (isvanadium)
		set_vanadium(update_default);
	// Iron Flow
	else if (isiron)
		set_iron(update_default);

	battsize_warning_check();
};

function is_flow()
{
	flow = false;
	if (value('batt_chem') == 2 || value('batt_chem') == 3)
		flow = true;
	return flow;
}

function set_flow()
{
	show('batt_bank_nseries_stacks', true);
	property('batt_size_choice', 'Items', ['Set desired bank size', 'Specify capacity and stack configuration']); 
	property('batt_series_label', 'Caption', 'Number of cells per stack');
	property('batt_parallel_label', 'Caption', 'Number of parallel stacks');
	property('batt_computed_parallel_label', 'Caption', 'Stacks in parallel');
	property('batt_computed_cells_series_label', 'Caption', 'Cells per stack');
}	
function set_conventional()
{
	show('batt_bank_nseries_stacks', false);
	property('batt_size_choice', 'Items', ['Set desired bank size', 'Specify cells']); 
	property('batt_series_label', 'Caption', 'Number of cells in series');
	property('batt_parallel_label', 'Caption', 'Number of strings in parallel');
	property('batt_computed_parallel_label', 'Caption', 'Strings in parallel');
	property('batt_computed_cells_series_label', 'Caption', 'Cells in series');
}

function set_chemistry()
{
	is_lead = (value('batt_chem') == 0);
	enable('LeadAcid_q20',is_lead);
	enable('LeadAcid_q20_computed',is_lead);
	enable('LeadAcid_q10',is_lead);
	enable('LeadAcid_q10_computed',is_lead);
	enable('LeadAcid_qn',is_lead);
	enable('LeadAcid_qn_computed',is_lead);
	
	// set widget properties
	if (is_flow())
		set_flow();
	else
		set_conventional();
}

function set_meter_position()
{
	f = financing();
	if ( !strcmp(f, 'Residential') 
	|| !strcmp(f, 'Commercial')
	|| !strcmp(f, 'Third Party')
	|| !strcmp(f, 'Host Developer') )
	{	
		// behind the meter
		${batt_meter_position} = 0;	
	}
	elseif (f == 'Single Owner' 
	|| f == 'Merchant Plant'
	|| f == 'Leveraged Partnership Flip'
	|| f == 'All Equity Partnership Flip'
	|| f == 'Sale Leaseback' )
	{
		// in front of the meter
		${batt_meter_position} = 1;	
	}
}
function set_lead_acid(update_default)
{
	lead_type = ${batt_type};
	
	if (update_default)
	{	
		// flooded lead acid
		if (lead_type == 0)
			flooded_lead_acid();
		else if (lead_type == 1)
			GEL();
		else if (lead_type == 2)
			AGM();
			
		lead_acid_defaults();	
	}
}
function set_lithium_ion(update_default)
{
	lithium_type = ${batt_type}-4;
	
	if (update_default)
	{
		if (lithium_type == 0)
			LMO();
		else if (lithium_type == 1)
			LFP();
		else if (lithium_type == 2)
			LCO();
		else if (lithium_type == 3)
			LTO();
		else if (lithium_type == 4)
			NMC();
		else if (lithium_type == 5)
			NCA();
			
		lithium_ion_defaults();
	}
}
function set_vanadium(update_default)
{
	if (update_default)
	{
		if (${batt_type} == 11)
			VRFB();
	}
}
function set_iron(update_default)
{
	// don't allow iron flow to use voltage model ever
	value('batt_voltage_choice', 1);
	if (update_default)
	{
		if (${batt_type} == 12)
			IronFlow();
	}
}

// Flooded Lead Acid defaults
function flooded_lead_acid()
{
	value('batt_specific_energy_per_mass',50); 
	value('batt_specific_energy_per_volume',98);
}

// AGM defaults
function AGM()
{
	value('batt_specific_energy_per_mass',35); 
	value('batt_specific_energy_per_volume',80);
}
// GEL defaults
function GEL()
{
	value('batt_specific_energy_per_mass',35); 
	value('batt_specific_energy_per_volume',75);
}


// Valve Regulated Lead Acid defaults
function lead_acid_defaults()
{

	ConversionEfficiencies();
	value('LeadAcid_q20',100);
	value('LeadAcid_q10',43);
	value('LeadAcid_qn',40);
	value('LeadAcid_tn',1);
	// desired bank voltage
	value('batt_resistance', 0.001); // from UBGC2, and DC400-6
	value('batt_bank_voltage', 12);
	value('batt_voltage_choice', 0);

	// voltage curve
	value('batt_C_rate',0.05);
	value('batt_Vfull',2.035);
	value('batt_Vexp',2.035);
	value('batt_Vnom',2);
	value('batt_Qfull',30);
	value('batt_Qexp_percent',82.25);
	value('batt_Qnom_percent',69.867);
	value('batt_Vnom_default',2);
	voltage_matrix = [[0,0]];
  	value('batt_voltage_matrix', voltage_matrix);
  	
		// Lifetime
	lifetime = [[100, 3, 107.0336711],
				[100, 78, 106.2367595],
				[100, 155, 99.31591834],
				[100, 225, 88.4519364],
				[100, 283, 76.90447695],
				[100, 331, 65.70010163],
				[60, 8, 99.66594258],
				[60, 82, 103.067629],
				[60, 157, 105.9231793],
				[60, 230, 108.0512886],
				[60, 305, 109.1644466],
				[60, 379, 109.01082],
				[60, 455, 107.1583692],
				[60, 531, 102.6818697],
				[60, 608, 95.91097842],
				[60, 682, 86.06425502],
				[60, 744, 74.42387647],
				[60, 783, 64.27151711],
				[50, 8, 99.6659426],
				[50, 82, 103.101846],
				[50, 155, 105.956063],
				[50, 230, 108.051289],
				[50, 305, 109.164447],
				[50, 379, 108.988919],
				[50, 455, 107.612098],
				[50, 530, 105.571679],
				[50, 606, 102.15444],
				[50, 682, 97.3285329],
				[50, 759, 90.9095439],
				[50, 835, 82.5464166],
				[50, 911, 72.1192173],
				[50, 962, 63.3411373],
				[30, 8, 99.66816445],
				[30, 82, 102.9787542],
				[30, 157, 105.8934062],
				[30, 230, 108.0512886],
				[30, 305, 109.2577652],
				[30, 379, 110.2242797],
				[30, 454, 110.8352945],
				[30, 528, 110.9241694],
				[30, 603, 110.5353418],
				[30, 679, 109.6465929],
				[30, 753, 108.2712539],
				[30, 829, 106.4115468],
				[30, 904, 104.0674716],
				[30, 981, 101.2390282],
				[30, 1056, 97.92399471],
				[30, 1131, 94.10015251],
				[30, 1208, 89.78083279],
				[30, 1283, 84.92604185],
				[30, 1360, 79.5268922],
				[30, 1437, 73.49006521],
				[30, 1513, 66.73557347],
				[30, 1565, 61.90605633]];
	value('batt_lifetime_matrix',lifetime);
	
	// turn calendar life model off
	value('batt_calendar_choice', 0);
	
	// Thermal
	cap_vs_temp = [[-27.69480083, 37.43024553],
				[-22.98152183, 44.52058055],
				[-18.26824283, 50.93737703],
				[-13.50829769, 56.73025835],
				[-8.748352565, 62.03789267],
				[-3.988407434, 67.12710044],
				[0.771537696, 72.128676],
				[5.531482826, 77.1616422],
				[10.29142796, 82.26916118],
				[15.05137309, 87.45384882],
				[19.81131822, 92.66469533],
				[24.57126335, 97.79183346],
				[29.33120848, 102.6926974],
				[34.09115361, 107.1436288],
				[38.85109874, 110.8921946],
				[43.61104387, 113.6205645],
				[48.0443261, 114.9503862]];
	value('cap_vs_temp', cap_vs_temp);
	
	// From Pesaran 2001: Thermal Characteristics of Selected EV and HEV batteries
	value('batt_Cp',660);
	
	// ancilliary system losses
	zero_array = fill_by_month(0);
	value('batt_losses_charging', zero_array);
	value('batt_losses_discharging', zero_array);
	value('batt_losses_idle', zero_array);

}
// Lithium Manganese Oxide
function LMO()
{
	// voltage curve
	value('batt_C_rate',1);
	value('batt_Vfull',4.2);
	value('batt_Vexp',4.1);
	value('batt_Vnom',3.6);
	value('batt_Qfull',1.5);
	value('batt_Qexp_percent',0.666);
	value('batt_Qnom_percent',93.33);
	value('batt_Vnom_default',3.6);
	value('batt_specific_energy_per_mass',92.5);
	value('batt_specific_energy_per_volume',231.97);
		
	// Lifetime
	lifetime = [[20,0,100],
				[20, 2500, 92], 
				[20,5000,84], 
				[80,0,100],
				[80, 500, 92], 
				[80,1000,84] ];
	value('batt_lifetime_matrix',lifetime);
}
// Lithium iron phospate
function LFP()
{
	// voltage curve
	value('batt_C_rate',0.43);
	value('batt_Vfull',3.6);
	value('batt_Vexp',3.4);
	value('batt_Vnom',3.3);
	value('batt_Qfull',2.3);
	value('batt_Qexp_percent',2.17);
	value('batt_Qnom',87);
	value('batt_Vnom_default',3.3);
	value('batt_specific_energy_per_mass',93.07);
	value('batt_specific_energy_per_volume',210.02);
		
	// Lifetime
	lifetime = [ [20,0,100],
				 [20,2500,98],
				 [20,5000,95],
				 [80,0,100],
				 [80,500,98],
				 [80,1000,95] ];
	value('batt_lifetime_matrix',lifetime);
}
// Lithium cobalt Oxide
function LCO()
{
	// voltage curve
	value('batt_C_rate',0.2);
	value('batt_Vfull',4.2);
	value('batt_Vexp',4.15);
	value('batt_Vnom',3.7);
	value('batt_Qfull',2.55);
	value('batt_Qexp_percent',0.40);
	value('batt_Qnom_percent',78.4);
	value('batt_Vnom_default',3.7);
	value('batt_specific_energy_per_mass',176.95);
	value('batt_specific_energy_per_volume',363.79);
		
	// Lifetime
	lifetime = [ [20,0,100],
				 [20,650,98],
				 [20,1500,95],
				 [80,0,102],
				 [80,150,93],
				 [80,300,87] ];
	value('batt_lifetime_matrix',lifetime);
}
// Lithium titanate
function LTO()
{
	// voltage curve
	value('batt_C_rate',1);
	value('batt_Vfull',2.8);
	value('batt_Vexp',2.4);
	value('batt_Vnom',2);
	value('batt_Qfull',12);
	value('batt_Qexp_percent',2.1);
	value('batt_Qnom_percent',91.7);
	value('batt_Vnom_default',2.3);
	value('batt_specific_energy_per_mass',69.12);
	value('batt_specific_energy_per_volume',118.43);
		
	// Lifetime
	lifetime = [ [20,0,100],
				 [20,10000,90],
				 [20,20000,85.42],
				 [20,30000, 83.33],
				 [80,0,100],
				 [80,2000,90],
				 [80,4000,85.42],
				 [80,6000, 83.33]];
	value('batt_lifetime_matrix',lifetime);
}
// Lithium nickel cobalt
function NMC()
{
	// voltage curve
	value('batt_C_rate',0.2);
	value('batt_Vfull',4.1);
	value('batt_Vexp',4.05);
	value('batt_Vnom',3.4);
	value('batt_Qfull',2.25);
	value('batt_Qexp_percent',1.78);
	value('batt_Qnom_percent',88.9);
	value('batt_Vnom_default',3.6);
	value('batt_specific_energy_per_mass',197.33);
	value('batt_specific_energy_per_volume',501.25);
		
	// Lifetime
	lifetime = [ [20,0,100],
				 [20,5000,80],
				 [20,10000,60],
				 [80,0,100],
				 [80,1000,80],
				 [80,2000,60]];
				
	value('batt_lifetime_matrix',lifetime);
}
// NMC
function NCA()
{
	// voltage curve
	value('batt_Vnom_default',3.6);
	value('batt_C_rate',0.2);
	value('batt_Vfull',4.2);
	value('batt_Vexp',4.1);
	value('batt_Vnom',3.6);
	value('batt_Qfull',55);
	value('batt_Qexp_percent',1.8);
	value('batt_Qnom_percent',98.2);
	value('batt_specific_energy_per_mass',202.90);
	value('batt_specific_energy_per_volume',532.58);
		
	// Lifetime
	lifetime = [ [20,0,100],
				 [20,5000,80],
				 [20,10000,60],
				 [80,0,100],
				 [80,1000,80],
				 [80,2000,60]];
	value('batt_lifetime_matrix',lifetime);
}
function lithium_ion_defaults()
{

	ConversionEfficiencies();

	if (financing() == 'Residential')
		value('batt_bank_voltage', 50);
	else
		value('batt_bank_voltage', 500);
		
	value('batt_voltage_choice', 0);
	voltage_matrix = [[0,0]];
  	value('batt_voltage_matrix', voltage_matrix);

	// Thermal
	value('batt_resistance', 0.001); // various manufactures
	cap_vs_temp = [ [-10, 60], [0, 80], [25, 100], [40, 100] ];
	value('cap_vs_temp', cap_vs_temp);

	// Maleki 1999 Thermal Properties of Lithium-Ion Battery & Components
	value('batt_Cp',1004);
	
	// turn on calendar lifetime model
	value('batt_calendar_choice', 1);
	
	// ancilliary system losses
	zero_array = fill_by_month(0);
	value('batt_losses_charging', zero_array);
	value('batt_losses_discharging', zero_array);
	value('batt_losses_idle', zero_array);
}
// Vanadium Redox Flow Battery
function VRFB()
{

	FlowDefaults();

	// voltage curve
	value('batt_Vnom_default',1.4);
	value('batt_C_rate',0.2);
	value('batt_Vfull',1.7);
	value('batt_Vexp',1.55);
	value('batt_Vnom',1.4);
	value('batt_Qfull',397);
	value('batt_Qexp_percent',10);
	value('batt_Qnom_percent',85);

	value('batt_voltage_choice', 0);
	voltage_matrix = [[0,0]];
  	value('batt_voltage_matrix', voltage_matrix);

	// dispatch control
	value('batt_minimum_SOC', 15);
	value('batt_maximum_SOC', 95);
	value('batt_minimum_modetime', 10);

	// thermal properties 
	// (from 2016 - Yan, Modelling and simulation of thermal behavior of vanadium redox flow battery)
	value('batt_Cp', 3200);

	// turn calendar life model off
	value('batt_calendar_choice', 0);
	
}
// Iron flow battery
function IronFlow()
{

	FlowDefaults();

	voltage_matrix = [[0, 1.18],
				  [20, 1.11],
				  [40, 1.08],
				  [60, 1.05],
				  [80, 1.02],
				  [100, 0.95]];

	// voltage curve
	value('batt_Vnom_default',1.1);
	value('batt_voltage_matrix', voltage_matrix);
	value('batt_voltage_choice', 1);

	// dispatch control
	value('batt_minimum_SOC', 0);
	value('batt_maximum_SOC', 100);
	value('batt_minimum_modetime', 0);

	// thermal properties
	value('batt_Cp', 3200); // unknown what this actually is
			
	// turn calendar life model off
	value('batt_calendar_choice', 0);
}

function FlowDefaults()
{

	ConversionEfficiencies();
	
	value('batt_resistance', 0.001);

	// desired bank voltage
	value('batt_bank_voltage', 48);
	
	// current control
	value('batt_current_choice', 0);
	value('batt_cell_power_discharge_max', 200);
	value('batt_cell_power_charge_max', 200);
	
	// ancilliary system losses
	value('batt_losses_charging', fill_by_month(0));
	value('batt_losses_discharging', fill_by_month(0));
	value('batt_losses_idle', fill_by_month(0));
	
	// Lifetime
	lifetime = [ [20,0,100],
				 [20,20000,100],
				 [80,0,100],
				 [80,20000,100]];
	value('batt_lifetime_matrix',lifetime);
	
	// Thermal
	cap_vs_temp = [ [19, 100], [21, 100] ];
	value('cap_vs_temp', cap_vs_temp);
	
	// thermal
	value('batt_specific_energy_per_mass',20);
	value('batt_specific_energy_per_volume',20);
}

function ConversionEfficiencies()
{
	value('batt_ac_dc_efficiency', 96);
	value('batt_dc_ac_efficiency', 96);
	value('batt_dc_dc_efficiency', 99);
}

function fill_by_month(num)
{
	month_array = [];
	for (m = 0; m != 12; m++)
		month_array[m] = num;
	return month_array;
}
